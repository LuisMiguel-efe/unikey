import numpy as np
from convert_template import hex_to_vector
from model import compile_siamese_network
import os
from dataset_train import hex_strings, labels

# Función para autenticar un usuario y devolver su etiqueta si se autentica
def authenticate_user(hex_str, stored_fingerprint_vectors, labels):
    # Convertir la nueva huella a vector
    new_fingerprint_vector = hex_to_vector(hex_str)
    
    # Cargar el modelo entrenado para predecir
    input_shape = new_fingerprint_vector.shape
    model_path = 'siamese_model.keras'
    if not os.path.exists(model_path):
        raise Exception("No se ha entrenado el modelo todavía.")
    
    model = compile_siamese_network(input_shape)
    model.load_weights(model_path)

    # Comparar con las huellas almacenadas
    for i, stored_vector in enumerate(stored_fingerprint_vectors):
        distance = model.predict([np.expand_dims(new_fingerprint_vector, axis=0), np.expand_dims(stored_vector, axis=0)])
        if distance < 0.01:  # Umbral que determina si es la misma huella
            return True, labels[i], distance  # Retorna True y la etiqueta del usuario
    
    return False, None, distance  # Si no hay coincidencia, retorna False y None(id) y distancia

# Ejemplo de autenticación
# Convertir todas las cadenas hexadecimales a vectores y almacenarlas en stored_fingerprints
stored_fingerprints = [hex_to_vector(hex_string) for hex_string in hex_strings]

# Huella de entrada
hex_input = "0200819E8B000B008495119ADF790000000527C2964A414A20BA6A7C51A03F2EA614851019E5451F866B192145E20B0A605170871E971469248AA885220A7629E14842DCDE2051BCD820A5149A38162585210E3629214794F2023851F955516D1495592A2005213F8E8B370300848E1192D5C804D3660527C2964A414A20BA6A2E75EF01FFFFFFFF0200827C519C3F2EA614861019E5451F866B192145E20B0A605170871C931469248AA885220A7629E14842DCDE2051BCD620A3149A38962585210E3629214794F2023851F955516D1495592A2005213F8E0000000000000000000000000000000000000000000000000000000000000000000000000000001C50EF01FFFFFFFF02008200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000084EF01FFFFFFFF02008200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
# huella no registrada
# hex_input = "B3048F5B9ED57322A6F52AF7E4C33EFD37A64B877771224A2345FCB672B0E438EB367B556736462E1DB44C82373538A1D526D2E6F7314694417A2C4211379F692455B1BDE62864F1CA241485436857D520D4830C2158C4BD391C524B8D6BF2C31093F60FE771DE13D9460527293A9B1135A30C4E29417AD126AB13712D353547DE01FFFFFFFF021072150AD072372149C439AF0941D0195B89148249B39D041842D1863148F5041D2B51B431248F356607135D7B4E0E1385F8F000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000152AEB01FFFFFFFF02008200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000084EF01FFFFFFFF02008100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"

# Llamar a la función de autenticación
is_authenticated, user_label, distance = authenticate_user(hex_input, stored_fingerprints, labels)

# Mostrar el resultado
if is_authenticated:
    print(f"Usuario autenticado: id: {user_label}, distancia: {distance}")
else:
    print(f"Autenticación fallida. D = {distance}")
